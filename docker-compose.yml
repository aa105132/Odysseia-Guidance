services:
  bot_app:
    restart: unless-stopped
    mem_limit: 1g
    env_file:
      - .env
    environment:
      - RUNNING_IN_DOCKER=true
    build:
      context: .
      dockerfile: .devcontainer/Dockerfile
    image: odysseia-guidance-bot_app:latest
    container_name: Odysseia_Guidance
    volumes:
      - .:/app
      - ./data:/app/data
      - /var/run/docker.sock:/var/run/docker.sock
    # --- DEV请 取消 注释下面的command:sleep命令并且 注释 掉command: python ---
    #command: sleep infinity
    command: python3 -u -m src.main
    networks:
      - bot_network
    # 如果使用外部数据库，注释掉 depends_on
    # depends_on:
    #   - db

  dashboard:
    restart: unless-stopped
    mem_limit: 512m
    env_file:
      - .env
    environment:
      - RUNNING_IN_DOCKER=true
    # dashboard 不需要单独构建，直接复用 bot_app 的镜像
    image: odysseia-guidance-bot_app:latest
    depends_on:
      - bot_app
    container_name: Odysseia_Dashboard
    volumes:
      - .:/app
      - ./data:/app/data
    ports:
      - "${DASHBOARD_PORT:-8080}:8080"
    networks:
      - bot_network
    # 如果使用外部数据库，注释掉 depends_on
    # depends_on:
    #   - db
    command: python3 -u -c "import uvicorn; uvicorn.run('src.dashboard.api:app', host='0.0.0.0', port=8080)"

  # ================================================================
  # 如果你要使用内置的 ParadeDB 数据库，取消下面的注释
  # 如果使用外部数据库（如1Panel的PostgreSQL），保持注释状态
  # ================================================================
  # db:
  #   image: paradedb/paradedb:latest-pg16
  #   container_name: odysseia_pg_db
  #   restart: unless-stopped
  #   environment:
  #     POSTGRES_DB: ${POSTGRES_DB:-odysseia_db}
  #     POSTGRES_USER: ${POSTGRES_USER:-user}
  #     POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
  #   volumes:
  #     - ./pgdata:/var/lib/postgresql/data
  #   networks:
  #     - bot_network

networks:
  bot_network:
    # 使用外部网络连接到1Panel的PostgreSQL容器
    # 如果1Panel的PostgreSQL在 1panel-network 中，使用 external
    external: true
    name: 1panel-network  # 改成你1Panel使用的网络名称
