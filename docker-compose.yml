services:
  # Bot 和 Dashboard 整合在同一容器中运行
  # Dashboard 作为后台线程与 Bot 一起启动
  bot_app:
    restart: unless-stopped
    mem_limit: 1g
    env_file:
      - .env
    environment:
      - RUNNING_IN_DOCKER=true
      # Dashboard 配置
      - DASHBOARD_ENABLED=true
      - DASHBOARD_HOST=0.0.0.0
      - DASHBOARD_PORT=8080
    build:
      context: .
      dockerfile: .devcontainer/Dockerfile
    image: odysseia-guidance-bot_app:latest
    container_name: Odysseia_Guidance
    volumes:
      - .:/app
      - ./data:/app/data
      - /var/run/docker.sock:/var/run/docker.sock
    # Dashboard 端口映射（与 Bot 在同一容器中）
    ports:
      - "${DASHBOARD_PORT:-8080}:8080"
    # --- DEV请 取消 注释下面的command:sleep命令并且 注释 掉command: python ---
    #command: sleep infinity
    command: python3 -u -m src.main
    networks:
      - bot_network
    # 如果使用外部数据库，注释掉 depends_on
    # depends_on:
    #   - db

  # ================================================================
  # 注意：Dashboard 已整合到 bot_app 容器中
  # 不再需要单独的 dashboard 服务
  # 如需禁用 Dashboard，设置环境变量 DASHBOARD_ENABLED=false
  # ================================================================

  # ================================================================
  # 如果你要使用内置的 ParadeDB 数据库，取消下面的注释
  # 如果使用外部数据库（如1Panel的PostgreSQL），保持注释状态
  # ================================================================
  # db:
  #   image: paradedb/paradedb:latest-pg16
  #   container_name: odysseia_pg_db
  #   restart: unless-stopped
  #   environment:
  #     POSTGRES_DB: ${POSTGRES_DB:-odysseia_db}
  #     POSTGRES_USER: ${POSTGRES_USER:-user}
  #     POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
  #   volumes:
  #     - ./pgdata:/var/lib/postgresql/data
  #   networks:
  #     - bot_network

networks:
  bot_network:
    # 使用外部网络连接到1Panel的PostgreSQL容器
    # 如果1Panel的PostgreSQL在 1panel-network 中，使用 external
    external: true
    name: 1panel-network  # 改成你1Panel使用的网络名称
