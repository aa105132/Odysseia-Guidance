services:
  bot_app:
    restart: unless-stopped # 2. 设置重启策略
    mem_limit: 1g # 1. 设置内存硬限制为 1GB (您可以根据VPS配置调整)
    env_file:
      - .env
    environment:
      - RUNNING_IN_DOCKER=true
    #build:
    #  context: .
    #  dockerfile: .devcontainer/Dockerfile
    #  network: host
    image: odysseia-guidance-bot_app:latest
    pull_policy: never
    container_name: Odysseia_Guidance
    volumes:
      - .:/app
      - ./data:/app/data
      - /var/run/docker.sock:/var/run/docker.sock
    # --- DEV请 取消 注释下面的command:sleep命令并且 注释 掉command: python ---
    #command: sleep infinity
    command: python3 -u -m src.main
    networks:
      - bot_network
    depends_on:
      - db

  dashboard:
    restart: unless-stopped
    mem_limit: 512m
    env_file:
      - .env
    environment:
      - RUNNING_IN_DOCKER=true
    image: odysseia-guidance-bot_app:latest
    pull_policy: never
    container_name: Odysseia_Dashboard
    volumes:
      - .:/app
      - ./data:/app/data
    ports:
      - "${DASHBOARD_PORT:-8080}:8080"
    networks:
      - bot_network
    depends_on:
      - db
    command: python3 -u -c "import uvicorn; uvicorn.run('src.dashboard.api:app', host='0.0.0.0', port=8080)"

  db:
    # 使用官方打包好的 ParadeDB 镜像，它基于 PG16
    image: paradedb/paradedb:latest-pg16
    container_name: odysseia_pg_db # 保持与项目其余部分一致的命名
    restart: unless-stopped # 保持与项目其余部分一致的重启策略
    environment:
      # 沿用 .env 文件中的变量，更加灵活和安全
      POSTGRES_DB: ${POSTGRES_DB:-odysseia_db}
      POSTGRES_USER: ${POSTGRES_USER:-user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
    #    ports:
    #      # 沿用变量端口映射，方便在不同环境中部署
    #      - "${DB_PORT:-5432}:5432"
    volumes:
      # 数据持久化到本地 ./pgdata 目录，并使用 PG16 的标准数据路径
      - ./pgdata:/var/lib/postgresql/data
    networks:
      - bot_network

networks:
  bot_network:
    driver: bridge
